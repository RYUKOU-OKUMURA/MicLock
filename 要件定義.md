# MicLock 要件定義・アーキテクチャ・技術スタック（v1）

最終更新日: 2026-02-12  
対象: macOS 向けマイク入力音量ロックツール

## 1. 目的と前提

### 1.1 目的
- ユーザーが指定したマイク入力音量（例: 80%）を維持する。
- 外部アプリやシステム変更で音量が変わっても、自動で目標値へ戻す。
- 非エンジニアでも導入・利用・設定変更ができる体験を提供する。

### 1.2 開発・運用前提
- 開発担当は非エンジニア（AI支援あり）。
- 利用者も非エンジニアを想定し、CLIや手動plist編集を前提にしない。
- 1台のMacでの個人利用を初期ターゲットとする。

### 1.3 成功条件（KPI）
- 初回セットアップ完了率: 90%以上（説明書を見ながら10分以内）。
- 日常利用で「設定変更のためにターミナルを開く」必要がない。
- 音量変化検知から復帰まで: 通常1秒以内。
- 異常時（非対応デバイス等）に、ユーザーが原因を画面で認識できる。

## 2. スコープ

### 2.1 対象（In Scope）
- デフォルト入力デバイスの現在音量を監視。
- 目標音量とのズレ検知時に自動補正。
- メニューバーUIでのON/OFF、目標値変更、状態確認。
- ログイン時自動起動のON/OFF。
- 非対応デバイス検知とユーザー通知。

### 2.2 対象外（Out of Scope）
- マイク音質処理（ノイズ除去、EQ、AGCなど）。
- 複数デバイス同時ロック（v1ではデフォルト入力のみ）。
- iOS/iPadOS/Windows対応。
- リモート管理・クラウド同期。

## 3. ユーザー要件（非エンジニア重視）

### 3.1 主要ユーザー
- 会議配信や録音時にマイク音量の意図しない変動を防ぎたいユーザー。
- ターミナル操作やシステム設定の深い知識がないユーザー。

### 3.2 UX要件
- 主要操作を3つに限定: `ロックON/OFF`、`目標音量の変更`、`状態確認`。
- 専門用語を避ける（例: 「settable」ではなく「このマイクは音量固定に未対応」）。
- 異常時は「何が起きたか」「どうすればいいか」を1画面で表示。
- 常時Dock表示は不要（メニューバー常駐 + 必要時のみ設定ウィンドウ）。

## 4. 機能要件

### 4.1 コア機能（FR）
- FR-01: デフォルト入力デバイスIDを取得できること。
- FR-02: 対象デバイスの入力音量（0.0-1.0）を取得できること。
- FR-03: 対象デバイスへ入力音量を設定できること。
- FR-04: masterエレメントがない場合、チャンネル単位へフォールバックすること。
- FR-05: 音量可変不可デバイスは「未対応」として扱い、無限リトライしないこと。

### 4.2 監視・復帰機能
- FR-06: 音量変化イベント（Property Listener）を優先検知すること。
- FR-07: 補助として周期監視（既定500ms、設定可能）を実行すること。
- FR-08: `abs(current - target) > epsilon` のときのみ補正を実行すること。
- FR-09: デフォルト入力デバイス変更時に1秒以内で追従すること。
- FR-10: 補正失敗時はバックオフし、ログに理由を記録すること。

### 4.3 UI機能
- FR-11: メニューバー上で現在状態（Locked/Unlocked/Error）を表示。
- FR-12: スライダーまたはプリセットで目標音量を変更できること。
- FR-13: 「自動起動」「監視間隔」「許容差（epsilon）」を設定可能にすること。
- FR-14: 最後に発生したエラーと対処方法を表示すること。
- FR-15: 1クリックで一時停止（例: 30分）できること。

### 4.4 永続化・起動
- FR-16: 設定は再起動後も維持されること。
- FR-17: ログイン時に自動起動できること。
- FR-18: 初回起動時にチュートリアル（30秒以内）を表示すること。

### 4.5 運用支援
- FR-19: 「診断情報をコピー」機能でデバイス情報・設定値・直近エラーを取得できること。
- FR-20: リセット操作で既定設定に戻せること。

## 5. 非機能要件

### 5.1 性能
- NFR-01: 通常時CPU使用率は低負荷（目安: 常時1%未満）。
- NFR-02: メモリ使用量は軽量（目安: 100MB未満）。
- NFR-03: 監視タイマはバックグラウンド優先度を適切に設定すること。

### 5.2 信頼性
- NFR-04: クラッシュ時の自動再起動手段を持つ（ログイン項目 + 再起動時復元）。
- NFR-05: CoreAudioエラー時でもアプリ全体は継続動作し、復帰可能であること。
- NFR-06: デバイス抜き差し時のハング/クラッシュを起こさないこと。

### 5.3 セキュリティ・プライバシー
- NFR-07: マイク音声データ自体は取得・保存・送信しない。
- NFR-08: 設定・ログはローカル保存のみ（v1）。
- NFR-09: 外部通信不要で動作する。

### 5.4 保守性
- NFR-10: ロジック層（Audio制御）とUI層を分離する。
- NFR-11: 主要ロジックにユニットテストを用意する。
- NFR-12: 非エンジニア向けに、更新手順を1ページで完結させる。

## 6. 受け入れ基準（UAT）

- UAT-01: アプリ起動後、設定した目標音量に自動補正される。
- UAT-02: 別アプリで音量変更しても、1秒以内に目標値へ戻る。
- UAT-03: マイク切替時に新デバイスへ自動追従する。
- UAT-04: 非対応デバイス利用時、ユーザーへ明示メッセージが表示される。
- UAT-05: メニューバーのみでON/OFF・目標値変更・状態確認が可能。
- UAT-06: 再ログイン後も前回設定が維持される。
- UAT-07: 一時停止後、時間経過で自動復帰する。

## 7. アーキテクチャ

### 7.1 全体構成
- 構成方針: 「単一macOSアプリ（MenuBar主体）」。
- 主要レイヤ:
  - Presentation Layer: SwiftUI（MenuBarExtra + 設定画面）
  - Application Layer: 状態管理、ユースケース実行、設定反映
  - Domain Layer: 音量ロック判定、復帰ポリシー、エラー分類
  - Infrastructure Layer: CoreAudioアクセス、設定保存、ロギング、起動管理

### 7.2 コンポーネント責務
- `MenuBarController`
  - アイコン状態表示、クイック操作を提供。
- `SettingsViewModel`
  - 設定値編集とバリデーションを担当。
- `MicLockEngine`
  - 監視開始/停止、目標値との差分判定、補正実行。
- `AudioDeviceRepository`
  - デフォルト入力デバイス取得、音量読取/書込、対応可否判定。
- `DeviceObserver`
  - デバイス変更・音量変更イベントを受信。
- `PollingGuard`
  - イベント取りこぼしを補完する周期監視。
- `ConfigStore`
  - UserDefaultsへの設定保存/読込。
- `DiagnosticsLogger`
  - `os.Logger` で構造化ログを出力。
- `LaunchAtLoginManager`
  - 自動起動の有効/無効管理。

### 7.3 監視戦略（ハイブリッド）
- 主経路: `AudioObjectAddPropertyListenerBlock` で即時検知。
- 補助経路: 500msポーリングで取りこぼし防止。
- 判定式: `abs(current - target) > epsilon`。
- 補正順序: master -> channels。
- 補正不可時: 状態を `Unsupported` に遷移し、UIへ通知。

### 7.4 状態遷移モデル
- `Idle`: ロック停止中。
- `Monitoring`: 監視中（正常）。
- `Correcting`: 補正処理中。
- `Unsupported`: デバイス非対応（読取/書込不可）。
- `Error`: 一時エラー（API失敗、デバイス不在など）。

遷移ルール:
- 起動時: `Idle -> Monitoring`（ロックONが既定の場合）。
- 監視中にズレ検知: `Monitoring -> Correcting -> Monitoring`。
- 非対応判定: `Monitoring -> Unsupported`。
- ユーザー再試行/デバイス変更: `Unsupported -> Monitoring`。

### 7.5 データモデル
- `AppSettings`
  - `isLockEnabled: Bool`
  - `targetVolume: Float` (0.0...1.0)
  - `pollingIntervalSec: Double`
  - `epsilon: Float`
  - `launchAtLogin: Bool`
  - `pauseUntil: Date?`
- `RuntimeStatus`
  - `activeDeviceID: AudioDeviceID?`
  - `activeDeviceName: String?`
  - `state: EngineState`
  - `lastErrorCode: String?`
  - `lastErrorMessage: String?`
  - `lastCorrectionAt: Date?`

### 7.6 エラーハンドリング方針
- ユーザー向けエラー（わかりやすい文言）と、開発向け詳細ログを分離。
- 同一エラー連発時は通知抑制（スパム防止）。
- 復帰可能エラーは自動再試行、復帰不能は明示停止。

## 8. 技術スタック

### 8.1 必須技術
- 言語: Swift（最新安定版）
- IDE: Xcode（最新安定版）
- UI: SwiftUI（`MenuBarExtra`）
- 音量制御: CoreAudio / AudioToolbox
- ログ: OSLog (`Logger`)
- 自動起動: ServiceManagement (`SMAppService`)
- 永続化: UserDefaults

### 8.2 採用理由
- Swift + CoreAudioはmacOS音声制御の一次APIであり依存が少ない。
- SwiftUI MenuBar構成は非エンジニア利用に必要な最小UIを低コストで提供可能。
- `SMAppService` はLaunchAgent手書きより保守しやすく、UI統合しやすい。

### 8.3 依存ライブラリ方針
- v1は原則標準フレームワークのみ。
- 外部ライブラリは導入コストと保守性を下げるため最小化。

### 8.4 テストスタック
- Unit Test: XCTest（ロジック・設定バリデーション中心）。
- 手動E2E: 実機チェックリスト（デバイス切替、再起動、会議アプリ併用）。
- 将来拡張: UIテスト（XCUITest）はv2で導入可。

### 8.5 配布方針
- v1: ローカルビルド `.app` 配布（小規模利用）。
- v1.1以降: 署名/Notarizationを実施し、初回起動警告を減らす。

## 9. 実装ロードマップ

### Phase 1: MVP（2-4日）
- コア音量ロック（イベント + ポーリング）。
- メニューバーUI（ON/OFF、目標音量、状態表示）。
- UserDefaults保存。
- 自動起動ON/OFF。

### Phase 2: 運用強化（2-3日）
- エラー文言改善、診断情報コピー。
- 一時停止機能。
- 通知抑制/再試行ポリシー実装。

### Phase 3: 配布品質（1-2日）
- 署名/Notarization（必要時）。
- 初回ガイド改善。
- リリースノートテンプレート整備。

## 10. 想定リスクと対策

- リスク: デバイスが入力音量制御非対応。
  - 対策: 非対応判定を明示し、設定画面で代替案を表示。
- リスク: 別アプリと音量奪い合い。
  - 対策: `epsilon` 設定 + 一時停止 + 補正間隔調整。
- リスク: 非エンジニアが更新手順で詰まる。
  - 対策: クリックベースの更新導線、診断情報の可視化。
- リスク: CoreAudio APIの扱いミス（可変長構造体など）。
  - 対策: Unsafe領域は薄いラッパー化し、単体テストと実機検証を必須化。

## 11. 実装時の設計原則（非エンジニア開発向け）

- 原則1: 操作はUI中心、CLIはデバッグ用途に限定。
- 原則2: 失敗時に「次に何をすればよいか」を必ず表示。
- 原則3: 設定項目は必要最小限（初期値を強めに設計）。
- 原則4: ロジックをモジュール化し、AIに修正依頼しやすい構造を維持。

---

この文書を v1 仕様ベースラインとし、実装開始前に以下だけ最終決定する。  
1) 既定目標値（例: 0.8）  
2) 既定監視間隔（例: 0.5秒）  
3) 一時停止プリセット（15/30/60分）  
